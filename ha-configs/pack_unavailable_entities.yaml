###################################################################################################
## PACKAGE: Unavailable Entities Sensor
## DESCRIPTION: Count and list entities with a state of unknown or unavailable
## REQUIREMENTS: Home Assistant v2022.5
## USAGE: https://github.com/jazzyisj/unavailable-entities-sensor/blob/main/README.md
###################################################################################################

# REQUIRED - This is the template sensor

template:
  - sensor:
      - name: "Unavailable Entities"
        unique_id: unavailable_entities
        icon: "{{ iif(states(this.entity_id)|int(-1) > 0, 'mdi:alert-circle', 'mdi:check-circle') }}"
        state_class: measurement
        unit_of_measurement: entities
        state: >
          {% set entities = state_attr(this.entity_id, 'entityids') %}
          {{ entities | count if entities != none else none }}
        attributes:
          entityids: >
            {% set ignore_seconds = 120 %}
            {% set ignored = state_attr('group.ignored_unavailable_entities', 'entity_id') %}
            {% set ignore_ts = (now().timestamp() - ignore_seconds)|as_datetime %}
            {% set entities = states
                | rejectattr('domain','in',['button', 'event', 'group', 'image', 'input_button', 'input_text', 'remote', 'tts', 'scene', 'stt'])
                | rejectattr('last_changed', 'ge', ignore_ts)
                | selectattr('state','in',['unavailable']) %}
            {% set entities =  entities | rejectattr('entity_id', 'in', ignored) if ignored != none else entities %}
            {{ entities | map(attribute='entity_id') | reject('has_value') | list | sort }}

      - name: "Unknown Entities"
        unique_id: unknown_entities
        icon: "{{ iif(states(this.entity_id)|int(-1) > 0, 'mdi:alert-circle', 'mdi:check-circle') }}"
        state_class: measurement
        unit_of_measurement: entities
        state: >
          {% set entities = state_attr(this.entity_id, 'entityids') %}
          {{ entities | count if entities != none else none }}
        attributes:
          entityids: >
            {% set ignore_seconds = 120 %}
            {% set ignored = state_attr('group.ignored_unknown_entities', 'entity_id') %}
            {% set ignore_ts = (now().timestamp() - ignore_seconds)|as_datetime %}
            {% set entities = states
                | rejectattr('domain','in',['button', 'event', 'group', 'image', 'input_button', 'input_text', 'remote', 'tts', 'scene', 'stt'])
                | rejectattr('last_changed', 'ge', ignore_ts)
                | selectattr('state','in',['unknown']) %}
            {% set entities =  entities | rejectattr('entity_id', 'in', ignored) if ignored != none else entities %}
            {{ entities | map(attribute='entity_id') | reject('has_value') | list | sort }}

      - name: "None Entities"
        unique_id: none_entities
        icon: "{{ iif(states(this.entity_id)|int(-1) > 0, 'mdi:alert-circle', 'mdi:check-circle') }}"
        state_class: measurement
        unit_of_measurement: entities
        state: >
          {% set entities = state_attr(this.entity_id, 'entityids') %}
          {{ entities | count if entities != none else none }}
        attributes:
          entityids: >
            {% set ignore_seconds = 120 %}
            {% set ignored = state_attr('group.ignored_none_entities', 'entity_id') %}
            {% set ignore_ts = (now().timestamp() - ignore_seconds)|as_datetime %}
            {% set entities = states
                | rejectattr('domain','in',['button', 'event', 'group', 'image', 'input_button', 'input_text', 'remote', 'tts', 'scene', 'stt'])
                | rejectattr('last_changed', 'ge', ignore_ts)
                | selectattr('state','in',['none']) %}
            {% set entities =  entities | rejectattr('entity_id', 'in', ignored) if ignored != none else entities %}
            {{ entities | map(attribute='entity_id') | reject('has_value') | list | sort }}

# OPTIONAL - Add entities you want to ignore to this group.  Delete if not using group.

group:
  ignored_unavailable_entities:
    entities:
      - climate.air_conditioner
      - sensor.epson_xp_4200_series
      - sensor.epson_xp_4200_series_black_ink
      - sensor.epson_xp_4200_series_cyan_ink
      - sensor.epson_xp_4200_series_magenta_ink
      - sensor.epson_xp_4200_series_yellow_ink
      - number.downstairs_zone_quick_veto_duration
      - number.upstairs_zone_quick_veto_duration
      - select.ohme_home_pro_charge_mode
  ignored_unknown_entities:
    entities:
      - select.driveway_ptz_preset
      - select.front_door_doorbell_play_quick_reply_message
      - siren.driveway_siren
      - siren.front_door_doorbell_siren
      - update.hallway_pir_firmware
      - update.kitchen_door_contact_firmware
      - update.kitchen_sink_leak_firmware
      - update.landing_pir_firmware
      - update.living_room_button_firmware
      - update.our_bedroom_door_button_firmware
      - update.playroom_button_firmware
      - update.stairs_bottom_button_firmware
      - update.stairs_top_button_firmware
      - update.study_air_quality_firmware
      - update.tz3000_mw1pqqqt_ts0003_firmware
      - update.front_door_contact_firmware
      - update.living_room_door_contact_firmware
      - binary_sensor.downstairs_circuit_cooling_allowed
      - binary_sensor.upstairs_circuit_cooling_allowed
      - sensor.downstairs_zone_desired_cooling_temperature
      - sensor.upstairs_zone_desired_cooling_temperature
