###############################################################################
# NOTES #######################################################################
###############################################################################

# SDCard
# 3 SS
# 4 MOSI
# 5 SCK
# 6 MISO
# 7 CD

# ePaper Panel
# 35 BUSY
# 36 RST
# 37 DC
# 38 CS
# 39 CLK
# 40 MOSI

# LEDs
# 2 LED

# Other
# 41 Input 1
# 42 Input 2
# 8 Relay

# 21 Relay

###############################################################################
# BASE DEVICE CONFIG ##########################################################
###############################################################################

substitutions:
  name: revk-epd-731bac
  friendly_name: RevK EPD 731bac ePaper

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  name_add_mac_suffix: false
  platformio_options:
    board_build.flash_mode: dio
    board_build.flash_size: 8MB
  on_boot:
      priority: 200.0
      then:
        - script.execute: update_screen
        - wait_until:
            condition:
              lambda: 'return id(data_updated) == true;'
        - delay: 5s # Wait a bit longer so all the items are received
        - logger.log: "Initial data received. Refreshing display"
        - lambda: 'id(initial_data_received) = true;'
        - lvgl.widget.hide: boot_screen
        - script.execute: update_screen

esp32:
  board: esp32-s3-devkitc-1
  variant: esp32s3
  framework:
    type: esp-idf
    version: recommended
   
psram:
  mode: quad
  speed: 80MHz


################################################################################

# Wifi information
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: ${name}
    password: ${name}
  power_save_mode: NONE
#  use_address: ${name}.tgv.home
  on_connect:
    - lvgl.widget.show: lbl_wifistatus
  on_disconnect:
    - lvgl.widget.hide: lbl_wifistatus

captive_portal:

# Enable Home Assistant API
api:
  on_client_connected:
    - if:
        condition:
          lambda: 'return (0 == client_info.find("Home Assistant "));'
        then:
          - lvgl.widget.show: lbl_hastatus
  on_client_disconnected:
    - if:
        condition:
          lambda: 'return (0 == client_info.find("Home Assistant "));'
        then:
          - lvgl.widget.hide: lbl_hastatus

ota:
  platform: esphome

# Enable logging
logger:
  hardware_uart: USB_SERIAL_JTAG

###############################################################################
# INPUTS / OUTPUTS / MODULES ##################################################
###############################################################################

# Pins for Waveshare ePaper ESP Board
spi:
  clk_pin: GPIO39
  mosi_pin: GPIO40

light:
  - platform: esp32_rmt_led_strip
    rgb_order: GRB
    pin: GPIO2
    num_leds: 25
    chipset: ws2812
    name: "Edge LEDs"
    id: edge_leds
    effects:
      - addressable_rainbow:
          name: Rainbow Effect With Custom Values
          speed: 10
          width: 50
      - addressable_color_wipe:
          name: Color Wipe Effect With Custom Values
          colors:
            - red: 100%
              green: 0%
              blue: 0%
              num_leds: 5
              gradient: true
            - red: 0%
              green: 100%
              blue: 0%
              num_leds: 5
              gradient: true
            - red: 0%
              green: 0%
              blue: 100%
              num_leds: 5
              gradient: true
            - red: 0%
              green: 0%
              blue: 0%
              num_leds: 1
          add_led_interval: 100ms
          reverse: false

###############################################################################
# VARIABLES & SCRIPTS #########################################################
###############################################################################

# Global variables for detecting if the display needs to be refreshed
globals:
  - id: data_updated
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: initial_data_received
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: time_since_refresh
    type: int
    restore_value: no
    initial_value: '0'
  - id: recorded_display_refresh
    type: int
    restore_value: yes
    initial_value: '0'

# Script for updating screen - Refresh display and publish refresh count and time.
script:
  - id: update_screen
    then:
      #- lvgl.resume:
      - lambda: 'id(data_updated) = false;'
      - lambda: 'id(time_since_refresh) = 0;'
      - lvgl.widget.redraw:
      - lambda: 'id(recorded_display_refresh) += 1;'
      - lambda: 'id(display_last_update).publish_state(id(homeassistant_time).now().timestamp);'
      #- lvgl.pause:

# Check whether the display needs to be refreshed
time:
  - platform: homeassistant
    id: homeassistant_time
    on_time_sync:
      then:
        - logger.log: "Synchronized system clock"
    on_time:
      - seconds: 0
        minutes: /1
        then:
          - if:
              condition:
                and:
                  - lambda: 'return id(data_updated) == true;' # We have to have had new sensor data
                  - lambda: 'return id(time_since_refresh) >= 5;' # It has to have been at least 5 minutes since the last refresh
              then:
                - logger.log:
                    format: "Refreshing display - States are: Sensor Data %d / Rate Limit Timer %u"
                    args: [ 'id(data_updated)', 'id(time_since_refresh)' ]
                - script.execute: update_screen
              else:
                - logger.log:
                    format: "Skipping display refresh -  States are: Sensor Data %d / Rate Limit Timer %u"
                    args: [ 'id(data_updated)', 'id(time_since_refresh)' ]
                - lambda: 'id(time_since_refresh) += 1;'

      # - seconds: 0, 10, 20, 30, 45, 50
      #   minutes: /1
      #   then:
      #     - logger.log: "LEDs Off"
      #     - light.addressable_set:
      #         id: edge_leds
      #         range_from: 0
      #         range_to: 24
      #         red: 0%
      #         green: 0%
      #         blue: 0%
      # - seconds: 5, 15, 25, 35, 45, 55
      #   minutes: /1
      #   then:
      #     - logger.log: "LEDs On"
      #     - light.addressable_set:
      #         id: edge_leds
      #         range_from: 0
      #         range_to: 24
      #         red: 25%
      #         green: 25%
      #         blue: 25%

###############################################################################
# HOME ASSISTANT BUTTONS ######################################################
###############################################################################

button:
  - platform: shutdown
    name: ESP32 Shutdown
  - platform: restart
    name: ESP32 Restart
  - platform: safe_mode
    name: ESP32 Restart (Safe Mode)
  - platform: template
    name: ESP32 Refresh Screen
    entity_category: config
    on_press:
      - script.execute: update_screen

switch:
  - platform: factory_reset
    name: ESP32 Factory Reset

###############################################################################
# BINARY SENSORS ##############################################################
###############################################################################

binary_sensor:
  - platform: status
    name: ESP32 Status

###############################################################################
# TEXT SENSORS ################################################################
###############################################################################

text_sensor:

  # Home Assistant General Sensors
  - platform: homeassistant
    entity_id: sensor.timeofday_greeting
    id: timeofday_greeting
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'


  # Weather Sensors - Now
  - platform: homeassistant
    entity_id: sensor.weather_now
    id: weather_now
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  # Weather Sensors - Daily
  - platform: homeassistant
    entity_id: sensor.weather_forecast_daily
    attribute: datetime0
    id: daily_forecast_datetime0
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_daily
    attribute: shorttime0
    id: daily_forecast_shorttime0
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_daily
    attribute: condition0
    id: daily_forecast_condition0
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_daily
    attribute: datetime1
    id: daily_forecast_datetime1
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_daily
    attribute: shorttime1
    id: daily_forecast_shorttime1
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_daily
    attribute: condition1
    id: daily_forecast_condition1
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'


  # Weather Sensors - Hourly
  - platform: homeassistant
    entity_id: sensor.weather_forecast_hourly
    attribute: datetime0
    id: hourly_forecast_datetime0
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'  
  
  - platform: homeassistant
    entity_id: sensor.weather_forecast_hourly
    attribute: shorttime0
    id: hourly_forecast_shorttime0
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_hourly
    attribute: condition0
    id: hourly_forecast_condition0
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_hourly
    attribute: datetime1
    id: hourly_forecast_datetime1
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_hourly
    attribute: shorttime1
    id: hourly_forecast_shorttime1
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_hourly
    attribute: condition1
    id: hourly_forecast_condition1
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'
  
  - platform: homeassistant
    entity_id: sensor.weather_forecast_hourly
    attribute: datetime2
    id: hourly_forecast_datetime2
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_hourly
    attribute: shorttime2
    id: hourly_forecast_shorttime2
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_hourly
    attribute: condition2
    id: hourly_forecast_condition2
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_hourly
    attribute: datetime3
    id: hourly_forecast_datetime3
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_hourly
    attribute: shorttime3
    id: hourly_forecast_shorttime3
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_hourly
    attribute: condition3
    id: hourly_forecast_condition3
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_hourly
    attribute: datetime4
    id: hourly_forecast_datetime4
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_hourly
    attribute: shorttime4
    id: hourly_forecast_shorttime4
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_hourly
    attribute: condition4
    id: hourly_forecast_condition4
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

##

###############################################################################
# GENERAL SENSORS #############################################################
###############################################################################

sensor:
    #Device UPTIME
  - platform: uptime
    name: ESP32 Uptime
    id: sys_uptime
    update_interval: 60s


  # Device Sensors - for monitoring device remotely
  - platform: template
    name: Display Last Update
    device_class: timestamp
    entity_category: "diagnostic"
    id: display_last_update
    
  - platform: template
    name: Display Num Refresh
    accuracy_decimals: 0
    unit_of_measurement: "Refreshes"
    state_class: "total_increasing"
    entity_category: "diagnostic"
    lambda: 'return id(recorded_display_refresh);'
  
  - platform: wifi_signal
    name: ESP32 WiFi Signal
    id: wifisignal
    unit_of_measurement: "dBm"
    entity_category: "diagnostic"
    update_interval: 60s

  # Home Assistant General Sensors

  # Weather Sensors - Now
  - platform: homeassistant
    entity_id: sensor.front_garden_climate_temperature
    id: temperature_now
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.front_garden_climate_humidity
    id: humidity_now
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.front_garden_climate_pressure
    id: pressure_now
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'


  # Weather Sensors - Daily
  - platform: homeassistant
    entity_id: sensor.weather_forecast_daily
    attribute: temperature0
    id: daily_forecast_temperature0
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_daily
    attribute: templow0
    id: daily_forecast_templow0
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_daily
    attribute: wind_speed0
    id: wind_speed0
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_daily
    attribute: wind_bearing0
    id: wind_bearing0
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_daily
    attribute: temperature1
    id: daily_forecast_temperature1
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_daily
    attribute: templow1
    id: daily_forecast_templow1
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_daily
    attribute: wind_speed1
    id: wind_speed1
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_daily
    attribute: wind_bearing1
    id: wind_bearing1
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  # Weather Sensors - Hourly
  - platform: homeassistant
    entity_id: sensor.weather_forecast_hourly
    attribute: temperature0
    id: hourly_forecast_temperature0
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_hourly
    attribute: temperature1
    id: hourly_forecast_temperature1
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_hourly
    attribute: temperature2
    id: hourly_forecast_temperature2
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_hourly
    attribute: temperature3
    id: hourly_forecast_temperature3
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

  - platform: homeassistant
    entity_id: sensor.weather_forecast_hourly
    attribute: temperature4
    id: hourly_forecast_temperature4
    on_value:
      then:
        - lambda: 'id(data_updated) = true;'

##

###############################################################################
# FONTS & TEXT ################################################################
###############################################################################

# Include custom fonts
font:
  - file:
      type: gfonts
      family: Montserrat
      weight: 500
    id: text_small
    size: 20
    extras:
      file:
        type: gfonts
        family: Montserrat
        weight: 500
      glyphs: [ "'", "£" ]

  - file:
      type: gfonts
      family: Montserrat
      weight: 500
    id: text_medium
    size: 40
    extras:
      file:
        type: gfonts
        family: Montserrat
        weight: 500
      glyphs: [ "'", "£" ]

  - file:
      type: gfonts
      family: Montserrat
      weight: 700
    id: text_medium_bold
    size: 40
    extras:
      file:
        type: gfonts
        family: Montserrat
        weight: 700
      glyphs: [ "'", "£" ]

  - file:
      type: gfonts
      family: Montserrat
      weight: 500
    id: text_large
    size: 50
    extras:
      file:
        type: gfonts
        family: Montserrat
        weight: 500
      glyphs: [ "'", "£" ]

  - file:
      type: gfonts
      family: Montserrat
      weight: 700
    id: text_large_bold
    size: 50
    extras:
      file:
        type: gfonts
        family: Montserrat
        weight: 700
      glyphs: [ "'", "£" ]

  - file:
      type: gfonts
      family: Montserrat
      weight: 700
    id: text_title
    size: 75
    extras:
      file:
        type: gfonts
        family: Montserrat
        weight: 700
      glyphs: [ "'", "£" ]

  - file: "https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/fonts/materialdesignicons-webfont.ttf"
    id: mdi_glyphs_medium
    size: 50
    glyphs: &mdi-glyphs
      - "\U000F18D7" # sun-thermometer-outline
      - "\U000F0594" # weather-night / clear-night
      - "\U000F0590" # weather-cloudy / cloudy
      - "\U000F0591" # weather-fog / fog
      - "\U000F0592" # weather-hail / hail
      - "\U000F0593" # weather-lightning / lightning
      - "\U000F067E" # weather-lightning-rainy / lightning-rainy
      - "\U000F0595" # weather-partly-cloudy / partlycloudy
      - "\U000F0596" # weather-pouring / pouring
      - "\U000F0597" # weather-rainy / rainy
      - "\U000F0598" # weather-snowy / snowy
      - "\U000F067F" # weather-snowy-rainy / snowy-rainy
      - "\U000F0599" # weather-sunny / sunny
      - "\U000F059D" # weather-windy / windy
      - "\U000F059E" # weather-windy-variant / windy-variant
      - "\U000F1C78" # weather-hurricane-outline / exceptional
      - "\U000F0F31" # weather-night-partly-cloudy / partlycloudy-night
      - "\U000F05CE" # clock-alert-outline
      - "\U000F018C" # compass-outline
      - "\U000F0D3E" # transmission-tower
      - "\U000F02D6" # Blank

  - file: "https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/fonts/materialdesignicons-webfont.ttf"
    id: mdi_glyphs_large
    size: 60
    glyphs: *mdi-glyphs

###############################################################################
# DISPLAY RENDERING ###########################################################
###############################################################################

# Now render everything on the ePaper screen
display:
  - platform: waveshare_epaper
    id: eink_display
    cs_pin: GPIO38
    dc_pin: GPIO37
    busy_pin:
      number: 35
      inverted: True
    reset_pin: GPIO36
    #reset_duration: 2ms
    model: 7.50inV2
    update_interval: never
    rotation: 270°

color:
  - id: paper_white # Really black, but will appear white on e-paper
    hex: "000000"
  - id: paper_black # Really white, but will appear black on e-paper
    hex: "FFFFFF"

lvgl:
  on_idle:
    - timeout: 30s
      then:
        - logger.log: "LVGL Idle 30s"
  on_pause:
    - logger.log: "LVGL Pause"
  on_resume:
    - logger.log: "LVGL Resume"
  on_boot:
    - logger.log: "LVGL Boot"
  on_draw_start:
    - logger.log: "LVGL Draw Start"
  on_draw_end:
    - logger.log: "LVGL Draw End"
    - component.update: eink_display

  bg_color: paper_white
  theme:
    label:
      text_font: text_medium
      text_color: paper_black

  style_definitions:
    - id: header_footer
      bg_color: paper_black
      bg_opa: COVER
      border_opa: TRANSP
      radius: 0
      pad_all: 0
      pad_row: 0
      pad_column: 0
      border_color: paper_white
      text_color: paper_white
      width: 100%
      height: 50
      text_font: montserrat_20

  top_layer:
    widgets:
      - obj:
          id: icon_area
          styles: header_footer
          width: 100%
          pad_left: 20px
          pad_right: 20px
          pad_top: 10px
          border_width: 0
          layout:
            type: FLEX
            flex_flow: ROW
            flex_align_main: space_between
            flex_align_cross: center
            pad_column: 20px
          widgets:
            - label:
                text: "Hello"
                text_font: montserrat_24
                flex_grow: 1
                align: left_mid
            - label:
                text: "\uF015" # HA Connectivity Icon
                id: lbl_hastatus
                text_font: montserrat_24
                align: center
            - label:
                text: "\uF1EB" # WiFI Connectivity Icon
                id: lbl_wifistatus
                text_font: montserrat_24
                align: center

      - obj:
          id: boot_screen
          x: 0
          y: 0
          height: 100%
          width: 100%
          align: CENTER
          bg_color: paper_white
          bg_opa: COVER
          radius: 0
          pad_all: 0
          border_width: 0
          widgets:
            - label:
                align: CENTER
                text: 'Refreshing Data - Pleae Wait'

  pages:
    - id: main_page
      widgets:
        - label:
            align: CENTER
            text: 'First Page 1'

    - id: second_page
      #skip: true
      widgets:
        - label:
            align: CENTER
            text: 'Second Page 2'

    - id: third_page
      #skip: true
      widgets:
        - label:
            align: CENTER
            text: 'Third Page 3'
